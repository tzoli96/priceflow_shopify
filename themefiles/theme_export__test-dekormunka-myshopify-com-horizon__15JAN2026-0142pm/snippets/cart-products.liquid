{% liquid
  assign block_settings = block.settings
%}

{%- comment -%}
  MODIFIED: Uses LocalStorage (custom-cart-items) instead of Shopify native cart.
  Items are rendered via JavaScript from LocalStorage data.
{%- endcomment -%}

<script src="{{ 'priceflow-cart.js' | asset_url }}" type="module"></script>

<div
  {{ block.shopify_attributes }}
  class="cart-items__wrapper"
  data-priceflow-cart-products
  {% if settings.product_title_case == 'uppercase' %}
    style="--product-title-case: uppercase;"
  {% endif %}
>
  {%- comment -%} Empty cart state - shown when LocalStorage is empty {%- endcomment -%}
  <div data-priceflow-empty-cart style="display: none;">
    {%- if shop.customer_accounts_enabled and customer == null -%}
      <p>
        {{ 'actions.log_in_html' | t: link: routes.account_login_url }}
      </p>
    {%- endif -%}

    <a
      class="button cart-items__empty-button"
      href="{{ settings.empty_cart_button_link | default: routes.all_products_collection_url }}"
    >
      {{ 'actions.continue_shopping' | t }}
    </a>
  </div>

  {%- comment -%} Cart with items - rendered via JavaScript {%- endcomment -%}
  <div data-priceflow-cart-items-container style="display: none;">
    <div
      class="cart-items spacing-style{% if block_settings.dividers %} cart-items--dividers{% endif %}"
      style="{% render 'spacing-style', settings: block_settings %} --cart-items-gap:{{ block_settings.gap | default: 16 | append: 'px' }};"
    >
      <table
        class="cart-items__table"
        role="table"
      >
        <caption
          class="visually-hidden"
          role="caption"
        >
          {{ 'content.cart_total' | t }}
          <span data-priceflow-total-caption>0</span>
        </caption>

        <thead
          class="visually-hidden"
          role="rowgroup"
        >
          <tr
            role="row"
            class="cart-items__table-row"
          >
            <th id="productImage" scope="col" role="columnheader">
              {{ 'content.product_image' | t }}
            </th>
            <th id="productInformation" scope="col" role="columnheader">
              {{ 'content.product_information' | t }}
            </th>
            <th id="quantity" scope="col" role="columnheader">
              {{ 'content.quantity' | t }}
            </th>
            <th id="productTotal" scope="col" role="columnheader">
              {{ 'content.product_total' | t }}
            </th>
          </tr>
        </thead>

        <tbody role="rowgroup" data-priceflow-cart-items-body>
          {%- comment -%} Items will be rendered here by JavaScript {%- endcomment -%}
        </tbody>
      </table>
    </div>
  </div>
</div>

<script>
(function() {
  'use strict';

  const STORAGE_KEY = 'custom-cart-items';

  // Translations (from Liquid)
  const translations = {
    remove: {{ 'accessibility.remove' | t | json }},
    removeItem: {{ 'accessibility.remove_item' | t: title: '[TITLE]' | json }},
    price: {{ 'content.price' | t | json }},
    quantity: {{ 'content.quantity' | t | json }}
  };

  // Settings
  const settings = {
    imageRatio: {{ block_settings.image_ratio | default: 'square' | json }},
    showVendor: {{ block_settings.vendor | default: false | json }},
    currencyCodeEnabled: {{ settings.currency_code_enabled_cart_items | default: false | json }},
    borderWidth: {{ settings.cart_thumbnail_border_width | default: 1 }},
    borderStyle: {{ settings.cart_thumbnail_border | default: 'solid' | json }},
    borderOpacity: {{ settings.cart_thumbnail_border_opacity | default: 100 }} / 100,
    borderRadius: {{ settings.cart_thumbnail_border_radius | default: 0 }}
  };

  /**
   * Get cart items from LocalStorage
   */
  function getCartItems() {
    try {
      const items = localStorage.getItem(STORAGE_KEY);
      return items ? JSON.parse(items) : [];
    } catch (error) {
      console.error('[Cart Products] Failed to load cart items:', error);
      return [];
    }
  }

  /**
   * Save cart items to LocalStorage
   */
  function saveCartItems(items) {
    try {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(items));
      window.dispatchEvent(new CustomEvent('cartUpdated', {
        detail: { items, itemCount: items.reduce((s, i) => s + i.quantity, 0) }
      }));
    } catch (error) {
      console.error('[Cart Products] Failed to save cart items:', error);
    }
  }

  /**
   * Format price
   */
  function formatPrice(price) {
    if (window.Shopify?.formatMoney) {
      return window.Shopify.formatMoney(price * 100);
    }
    return new Intl.NumberFormat('hu-HU', {
      style: 'currency',
      currency: 'HUF',
      minimumFractionDigits: 0,
      maximumFractionDigits: 2
    }).format(price);
  }

  /**
   * Render properties (filters out internal PriceFlow properties)
   */
  const HIDDEN_PROPERTIES = ['pricing_template', 'original_price', 'multiplier', 'custom_price', 'variant_id'];

  function renderProperties(properties) {
    if (!properties || Object.keys(properties).length === 0) return '';

    const visibleEntries = Object.entries(properties).filter(([key, value]) => {
      if (!value) return false;
      if (key.startsWith('_')) return false;
      if (HIDDEN_PROPERTIES.includes(key)) return false;
      return true;
    });

    if (visibleEntries.length === 0) return '';

    let html = '<dl class="cart-items__variants">';
    for (const [key, value] of visibleEntries) {
      // Format key for display (variant -> Variant)
      const displayKey = key.charAt(0).toUpperCase() + key.slice(1).replace(/_/g, ' ');
      html += `
        <div class="cart-items__properties">
          <dt>${escapeHtml(displayKey)}:</dt>
          <dd>${escapeHtml(String(value))}</dd>
        </div>
      `;
    }
    html += '</dl>';
    return html;
  }

  /**
   * Escape HTML
   */
  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  /**
   * Render a single cart item row
   */
  function renderCartItemRow(item, index) {
    const borderOverride = `--border-width: ${settings.borderWidth}px; --border-style: ${settings.borderStyle}; --border-color: rgb(var(--color-border-rgb) / ${settings.borderOpacity}); --border-radius: ${settings.borderRadius}px;${settings.borderRadius > 0 ? ' overflow: hidden;' : ''}`;

    let ratio = 1;
    if (settings.imageRatio === 'portrait') ratio = 0.8;

    const imageHtml = item.image ? `
      <a href="#" class="cart-items__media-container" style="--ratio:${ratio};">
        <img
          src="${escapeHtml(item.image)}"
          alt="${escapeHtml(item.product_title)}"
          class="cart-items__media-image border-style"
          style="${borderOverride}"
          width="250"
          loading="lazy"
        />
      </a>
    ` : '';

    const priceHtml = formatPrice(item.final_line_price);
    const unitPriceHtml = formatPrice(item.final_price);

    return `
      <tr
        role="row"
        class="cart-items__table-row"
        data-priceflow-cart-item
        data-item-id="${escapeHtml(item.id)}"
        data-index="${index + 1}"
      >
        <td class="cart-items__media" role="cell" headers="productImage">
          ${imageHtml}
        </td>
        <td class="cart-items__details cart-primary-typography" role="cell" headers="productInformation">
          <p>
            <span class="cart-items__title">${escapeHtml(item.product_title)}</span>
          </p>
          ${renderProperties(item.properties)}
          <div>
            <span>${unitPriceHtml}</span>
          </div>
        </td>
        <td class="cart-items__quantity" role="cell" headers="quantity">
          <div class="cart-items__quantity-controls">
            <div class="quantity-selector" data-priceflow-quantity-selector>
              <button
                type="button"
                class="quantity-selector__button"
                data-action="decrease"
                aria-label="Decrease quantity"
              >
                <span class="svg-wrapper">
                  {{- 'icon-minus.svg' | inline_asset_content -}}
                </span>
              </button>
              <input
                type="number"
                class="quantity-selector__input"
                value="${item.quantity}"
                min="0"
                max="999"
                data-priceflow-quantity-input
                aria-label="${translations.quantity}"
              />
              <button
                type="button"
                class="quantity-selector__button"
                data-action="increase"
                aria-label="Increase quantity"
              >
                <span class="svg-wrapper">
                  {{- 'icon-plus.svg' | inline_asset_content -}}
                </span>
              </button>
            </div>
            <button
              class="button button--tertiary cart-items__remove"
              type="button"
              aria-label="${translations.removeItem.replace('[TITLE]', escapeHtml(item.product_title))}"
              data-action="remove"
            >
              {{- 'icon-delete.svg' | inline_asset_content -}}
              <span class="visually-hidden">${translations.remove}</span>
            </button>
          </div>
        </td>
        <td class="cart-items__price cart-secondary-typography" role="cell" headers="productTotal">
          <span data-priceflow-line-price>${priceHtml}</span>
        </td>
      </tr>
    `;
  }

  /**
   * Render all cart items in ALL containers on the page
   */
  function renderCartItems() {
    // Find ALL cart product containers (there may be multiple in drawer)
    const containers = document.querySelectorAll('[data-priceflow-cart-products]');
    if (containers.length === 0) return;

    const items = getCartItems();
    const isEmpty = items.length === 0;
    const itemsHtml = items.map((item, index) => renderCartItemRow(item, index)).join('');
    const total = items.reduce((sum, item) => sum + (item.final_line_price || 0), 0);

    // Update ALL containers
    containers.forEach(container => {
      const emptyState = container.querySelector('[data-priceflow-empty-cart]');
      const itemsContainer = container.querySelector('[data-priceflow-cart-items-container]');
      const tbody = container.querySelector('[data-priceflow-cart-items-body]');
      const totalCaption = container.querySelector('[data-priceflow-total-caption]');

      if (!emptyState || !itemsContainer || !tbody) return;

      if (isEmpty) {
        emptyState.style.display = 'block';
        itemsContainer.style.display = 'none';
      } else {
        emptyState.style.display = 'none';
        itemsContainer.style.display = 'block';

        // Render items
        tbody.innerHTML = itemsHtml;

        // Update total caption
        if (totalCaption) {
          totalCaption.textContent = formatPrice(total);
        }

        // Attach event listeners
        attachEventListeners(container);
      }
    });
  }

  /**
   * Attach event listeners to cart item controls
   */
  function attachEventListeners(container) {
    // Quantity buttons
    container.querySelectorAll('[data-action="decrease"], [data-action="increase"]').forEach(btn => {
      btn.addEventListener('click', handleQuantityClick);
    });

    // Quantity inputs
    container.querySelectorAll('[data-priceflow-quantity-input]').forEach(input => {
      input.addEventListener('change', handleQuantityChange);
    });

    // Remove buttons
    container.querySelectorAll('[data-action="remove"]').forEach(btn => {
      btn.addEventListener('click', handleRemoveClick);
    });
  }

  /**
   * Handle quantity button click
   */
  function handleQuantityClick(event) {
    const btn = event.currentTarget;
    const action = btn.dataset.action;
    const row = btn.closest('[data-priceflow-cart-item]');
    const input = row?.querySelector('[data-priceflow-quantity-input]');

    if (!row || !input) return;

    let quantity = parseInt(input.value, 10) || 0;

    if (action === 'decrease') {
      quantity = Math.max(0, quantity - 1);
    } else if (action === 'increase') {
      quantity = Math.min(999, quantity + 1);
    }

    input.value = quantity;
    updateItemQuantity(row.dataset.itemId, quantity);
  }

  /**
   * Handle quantity input change
   */
  function handleQuantityChange(event) {
    const input = event.currentTarget;
    const row = input.closest('[data-priceflow-cart-item]');

    if (!row) return;

    let quantity = parseInt(input.value, 10) || 0;
    quantity = Math.max(0, Math.min(999, quantity));
    input.value = quantity;

    updateItemQuantity(row.dataset.itemId, quantity);
  }

  /**
   * Handle remove button click
   */
  function handleRemoveClick(event) {
    const btn = event.currentTarget;
    const row = btn.closest('[data-priceflow-cart-item]');

    if (!row) return;

    // Add removing animation
    row.style.setProperty('--row-height', `${row.clientHeight}px`);
    row.classList.add('removing');

    setTimeout(() => {
      updateItemQuantity(row.dataset.itemId, 0);
    }, 300);
  }

  /**
   * Update item quantity in LocalStorage
   */
  function updateItemQuantity(itemId, quantity) {
    let items = getCartItems();

    if (quantity <= 0) {
      // Remove item
      items = items.filter(item => item.id !== itemId);
    } else {
      // Update quantity
      items = items.map(item => {
        if (item.id === itemId) {
          return {
            ...item,
            quantity,
            final_line_price: item.final_price * quantity
          };
        }
        return item;
      });
    }

    saveCartItems(items);
    renderCartItems();
  }

  // Prevent duplicate initialization (script may be loaded multiple times in drawer)
  if (!window._priceflowCartProductsInitialized) {
    window._priceflowCartProductsInitialized = true;
    window._priceflowCartLastRender = 0;

    // Debounced render to prevent race conditions
    function debouncedRender() {
      const now = Date.now();
      // Skip if rendered less than 100ms ago
      if (now - window._priceflowCartLastRender < 100) {
        return;
      }
      window._priceflowCartLastRender = now;
      renderCartItems();
    }

    // Initial render with small delay to ensure localStorage is ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', function() {
        setTimeout(debouncedRender, 50);
      });
    } else {
      setTimeout(debouncedRender, 50);
    }

    // Listen for cart updates
    window.addEventListener('cartUpdated', debouncedRender);

    // Listen for storage changes (cross-tab sync)
    window.addEventListener('storage', function(event) {
      if (event.key === STORAGE_KEY) {
        debouncedRender();
      }
    });
  }
  // Don't re-render on duplicate script load - let events handle it

  // Export for external use
  window.renderPriceflowCartItems = renderCartItems;
})();
</script>

{% stylesheet %}
  /* ============================================
     PRICEFLOW CART - REFINED STYLES
     ============================================ */

  /* Scrollable container */
  .cart-drawer__items {
    flex: 1 !important;
    overflow-y: auto !important;
    overflow-x: hidden !important;
    padding: 0 20px !important;
    scrollbar-width: thin;
    scrollbar-color: rgba(0,0,0,0.2) transparent;
  }

  .cart-drawer__items::-webkit-scrollbar {
    width: 6px;
  }

  .cart-drawer__items::-webkit-scrollbar-track {
    background: transparent;
  }

  .cart-drawer__items::-webkit-scrollbar-thumb {
    background: rgba(0,0,0,0.2);
    border-radius: 3px;
  }

  .cart-drawer__items::-webkit-scrollbar-thumb:hover {
    background: rgba(0,0,0,0.3);
  }

  /* Container */
  .cart-items__wrapper {
    width: 100% !important;
    min-width: 0 !important;
  }

  .cart-items {
    width: 100% !important;
    min-width: 0 !important;
  }

  /* Table reset */
  .cart-items__table {
    display: block !important;
    width: 100% !important;
  }

  .cart-items__table thead {
    display: none !important;
  }

  .cart-items__table tbody {
    display: block !important;
    width: 100% !important;
  }

  /* Cart item row */
  .cart-items__table-row {
    display: grid !important;
    width: 100% !important;
    grid-template-columns: 80px 1fr auto !important;
    grid-template-rows: auto auto !important;
    grid-template-areas:
      'media details price'
      'media quantity quantity' !important;
    column-gap: 16px !important;
    row-gap: 8px !important;
    align-items: start !important;
    padding: 20px 0 !important;
    margin: 0 !important;
    border-bottom: 1px solid rgba(0,0,0,0.08) !important;
    transition: opacity 0.2s ease, background-color 0.2s ease !important;
  }

  .cart-items__table-row:first-child {
    padding-top: 0 !important;
  }

  .cart-items__table-row:last-child {
    border-bottom: none !important;
    padding-bottom: 20px !important;
  }

  .cart-items__table-row:hover {
    background-color: rgba(0,0,0,0.02) !important;
  }

  /* TD cells */
  .cart-items__table-row > td {
    display: block !important;
    min-width: 0 !important;
    padding: 0 !important;
  }

  /* Media / Image */
  .cart-items__media {
    grid-area: media !important;
    grid-row: 1 / 3 !important;
  }

  .cart-items__media-container {
    display: block !important;
    width: 80px !important;
    height: 80px !important;
    border-radius: 8px !important;
    overflow: hidden !important;
    background: rgba(0,0,0,0.05) !important;
  }

  .cart-items__media-image {
    width: 100% !important;
    height: 100% !important;
    object-fit: cover !important;
    transition: transform 0.3s ease !important;
  }

  .cart-items__table-row:hover .cart-items__media-image {
    transform: scale(1.05) !important;
  }

  /* Details */
  .cart-items__details {
    grid-area: details !important;
    display: flex !important;
    flex-direction: column !important;
    gap: 4px !important;
    min-width: 0 !important;
  }

  .cart-items__details p {
    margin: 0 !important;
  }

  .cart-items__title {
    display: block !important;
    font-size: 14px !important;
    font-weight: 600 !important;
    color: inherit !important;
    line-height: 1.4 !important;
    word-break: normal !important;
    overflow-wrap: break-word !important;
  }

  .cart-items__variants {
    margin: 0 !important;
    padding: 0 !important;
  }

  .cart-items__properties {
    display: block !important;
    font-size: 12px !important;
    color: rgba(0,0,0,0.6) !important;
    line-height: 1.4 !important;
  }

  .cart-items__properties dt {
    display: inline !important;
    font-weight: 500 !important;
    margin: 0 !important;
  }

  .cart-items__properties dd {
    display: inline !important;
    margin: 0 4px 0 0 !important;
  }

  /* Unit price under details */
  .cart-items__details > div:last-child {
    font-size: 13px !important;
    color: rgba(0,0,0,0.7) !important;
    margin-top: 2px !important;
  }

  /* Quantity */
  .cart-items__quantity {
    grid-area: quantity !important;
    display: flex !important;
    align-items: center !important;
    gap: 12px !important;
    margin: 0 !important;
  }

  .cart-items__quantity-controls {
    display: flex !important;
    align-items: center !important;
    gap: 12px !important;
  }

  .quantity-selector {
    display: inline-flex !important;
    align-items: center !important;
    background: rgba(0,0,0,0.04) !important;
    border: none !important;
    border-radius: 8px !important;
    overflow: hidden !important;
  }

  .quantity-selector__button {
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
    width: 36px !important;
    height: 36px !important;
    background: transparent !important;
    border: none !important;
    cursor: pointer !important;
    padding: 0 !important;
    color: inherit !important;
    transition: background-color 0.15s ease !important;
  }

  .quantity-selector__button:hover {
    background: rgba(0,0,0,0.08) !important;
  }

  .quantity-selector__button:active {
    background: rgba(0,0,0,0.12) !important;
  }

  .quantity-selector__input {
    width: 36px !important;
    height: 36px !important;
    text-align: center !important;
    border: none !important;
    background: transparent !important;
    font-size: 14px !important;
    font-weight: 500 !important;
    color: inherit !important;
    -moz-appearance: textfield !important;
  }

  .quantity-selector__input::-webkit-outer-spin-button,
  .quantity-selector__input::-webkit-inner-spin-button {
    -webkit-appearance: none !important;
    margin: 0 !important;
  }

  .cart-items__remove {
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
    width: 36px !important;
    height: 36px !important;
    background: transparent !important;
    border: none !important;
    border-radius: 8px !important;
    cursor: pointer !important;
    padding: 0 !important;
    color: inherit !important;
    opacity: 0.5 !important;
    transition: opacity 0.15s ease, background-color 0.15s ease !important;
  }

  .cart-items__remove:hover {
    opacity: 1 !important;
    background: rgba(220, 53, 69, 0.1) !important;
    color: #dc3545 !important;
  }

  /* Price */
  .cart-items__price {
    grid-area: price !important;
    display: block !important;
    text-align: right !important;
    font-size: 15px !important;
    font-weight: 600 !important;
    white-space: nowrap !important;
  }

  /* Empty cart */
  .cart-items__empty-button {
    display: inline-block !important;
    margin-top: 20px !important;
    padding: 14px 28px !important;
    font-weight: 500 !important;
  }

  /* Remove animation */
  .cart-items__table-row.removing {
    opacity: 0 !important;
    transform: translateX(20px) !important;
    transition: opacity 0.25s ease, transform 0.25s ease !important;
  }

  /* SVG icons */
  .quantity-selector__button .svg-wrapper,
  .cart-items__remove .svg-wrapper {
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
    width: 18px !important;
    height: 18px !important;
  }

  .quantity-selector__button svg,
  .cart-items__remove svg {
    width: 18px !important;
    height: 18px !important;
  }

  /* Responsive - smaller screens */
  @media (max-width: 400px) {
    .cart-items__table-row {
      grid-template-columns: 65px 1fr !important;
      grid-template-areas:
        'media details'
        'media price'
        'quantity quantity' !important;
      row-gap: 10px !important;
    }

    .cart-items__media {
      grid-row: 1 / 3 !important;
    }

    .cart-items__media-container {
      width: 65px !important;
      height: 65px !important;
    }

    .cart-items__price {
      text-align: left !important;
    }

    .cart-items__quantity {
      padding-top: 8px !important;
      border-top: 1px solid rgba(0,0,0,0.05) !important;
    }
  }
{% endstylesheet %}

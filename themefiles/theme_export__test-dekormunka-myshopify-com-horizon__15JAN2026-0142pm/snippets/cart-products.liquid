{% liquid
  assign block_settings = block.settings
%}

{%- comment -%}
  MODIFIED: Uses LocalStorage (custom-cart-items) instead of Shopify native cart.
  Items are rendered via JavaScript from LocalStorage data.
{%- endcomment -%}

<script src="{{ 'priceflow-cart.js' | asset_url }}" type="module"></script>

<div
  {{ block.shopify_attributes }}
  class="cart-items__wrapper"
  data-priceflow-cart-products
  {% if settings.product_title_case == 'uppercase' %}
    style="--product-title-case: uppercase;"
  {% endif %}
>
  {%- comment -%} Empty cart state - shown when LocalStorage is empty {%- endcomment -%}
  <div data-priceflow-empty-cart style="display: none;">
    {%- if shop.customer_accounts_enabled and customer == null -%}
      <p>
        {{ 'actions.log_in_html' | t: link: routes.account_login_url }}
      </p>
    {%- endif -%}

    <a
      class="button cart-items__empty-button"
      href="{{ settings.empty_cart_button_link | default: routes.all_products_collection_url }}"
    >
      {{ 'actions.continue_shopping' | t }}
    </a>
  </div>

  {%- comment -%} Cart with items - rendered via JavaScript {%- endcomment -%}
  <div data-priceflow-cart-items-container style="display: none;">
    <div
      class="cart-items spacing-style{% if block_settings.dividers %} cart-items--dividers{% endif %}"
      style="{% render 'spacing-style', settings: block_settings %} --cart-items-gap:{{ block_settings.gap | default: 16 | append: 'px' }};"
    >
      <table
        class="cart-items__table"
        role="table"
      >
        <caption
          class="visually-hidden"
          role="caption"
        >
          {{ 'content.cart_total' | t }}
          <span data-priceflow-total-caption>0</span>
        </caption>

        <thead
          class="visually-hidden"
          role="rowgroup"
        >
          <tr
            role="row"
            class="cart-items__table-row"
          >
            <th id="productImage" scope="col" role="columnheader">
              {{ 'content.product_image' | t }}
            </th>
            <th id="productInformation" scope="col" role="columnheader">
              {{ 'content.product_information' | t }}
            </th>
            <th id="quantity" scope="col" role="columnheader">
              {{ 'content.quantity' | t }}
            </th>
            <th id="productTotal" scope="col" role="columnheader">
              {{ 'content.product_total' | t }}
            </th>
          </tr>
        </thead>

        <tbody role="rowgroup" data-priceflow-cart-items-body>
          {%- comment -%} Items will be rendered here by JavaScript {%- endcomment -%}
        </tbody>
      </table>
    </div>
  </div>
</div>

<script>
(function() {
  'use strict';

  const STORAGE_KEY = 'custom-cart-items';

  // Translations (from Liquid)
  const translations = {
    remove: {{ 'accessibility.remove' | t | json }},
    removeItem: {{ 'accessibility.remove_item' | t: title: '[TITLE]' | json }},
    price: {{ 'content.price' | t | json }},
    quantity: {{ 'content.quantity' | t | json }}
  };

  // Settings
  const settings = {
    imageRatio: {{ block_settings.image_ratio | default: 'square' | json }},
    showVendor: {{ block_settings.vendor | default: false | json }},
    currencyCodeEnabled: {{ settings.currency_code_enabled_cart_items | default: false | json }},
    borderWidth: {{ settings.cart_thumbnail_border_width | default: 1 }},
    borderStyle: {{ settings.cart_thumbnail_border | default: 'solid' | json }},
    borderOpacity: {{ settings.cart_thumbnail_border_opacity | default: 100 }} / 100,
    borderRadius: {{ settings.cart_thumbnail_border_radius | default: 0 }}
  };

  /**
   * Get cart items from LocalStorage
   */
  function getCartItems() {
    try {
      const items = localStorage.getItem(STORAGE_KEY);
      return items ? JSON.parse(items) : [];
    } catch (error) {
      console.error('[Cart Products] Failed to load cart items:', error);
      return [];
    }
  }

  /**
   * Save cart items to LocalStorage
   */
  function saveCartItems(items) {
    try {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(items));
      window.dispatchEvent(new CustomEvent('cartUpdated', {
        detail: { items, itemCount: items.reduce((s, i) => s + i.quantity, 0) }
      }));
    } catch (error) {
      console.error('[Cart Products] Failed to save cart items:', error);
    }
  }

  /**
   * Format price
   */
  function formatPrice(price) {
    if (window.Shopify?.formatMoney) {
      return window.Shopify.formatMoney(price * 100);
    }
    return new Intl.NumberFormat('hu-HU', {
      style: 'currency',
      currency: 'HUF',
      minimumFractionDigits: 0,
      maximumFractionDigits: 2
    }).format(price);
  }

  /**
   * Render properties
   */
  function renderProperties(properties) {
    if (!properties || Object.keys(properties).length === 0) return '';

    let html = '<dl class="cart-items__variants">';
    for (const [key, value] of Object.entries(properties)) {
      if (key.startsWith('_') || !value) continue;
      html += `
        <div class="cart-items__properties">
          <dt>${escapeHtml(key)}:</dt>
          <dd>${escapeHtml(String(value))}</dd>
        </div>
      `;
    }
    html += '</dl>';
    return html;
  }

  /**
   * Escape HTML
   */
  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  /**
   * Render a single cart item row
   */
  function renderCartItemRow(item, index) {
    const borderOverride = `--border-width: ${settings.borderWidth}px; --border-style: ${settings.borderStyle}; --border-color: rgb(var(--color-border-rgb) / ${settings.borderOpacity}); --border-radius: ${settings.borderRadius}px;${settings.borderRadius > 0 ? ' overflow: hidden;' : ''}`;

    let ratio = 1;
    if (settings.imageRatio === 'portrait') ratio = 0.8;

    const imageHtml = item.image ? `
      <a href="#" class="cart-items__media-container" style="--ratio:${ratio};">
        <img
          src="${escapeHtml(item.image)}"
          alt="${escapeHtml(item.product_title)}"
          class="cart-items__media-image border-style"
          style="${borderOverride}"
          width="250"
          loading="lazy"
        />
      </a>
    ` : '';

    const priceHtml = formatPrice(item.final_line_price);
    const unitPriceHtml = formatPrice(item.final_price);

    return `
      <tr
        role="row"
        class="cart-items__table-row"
        data-priceflow-cart-item
        data-item-id="${escapeHtml(item.id)}"
        data-index="${index + 1}"
      >
        <td class="cart-items__media" role="cell" headers="productImage">
          ${imageHtml}
        </td>
        <td class="cart-items__details cart-primary-typography" role="cell" headers="productInformation">
          <p>
            <span class="cart-items__title">${escapeHtml(item.product_title)}</span>
          </p>
          ${renderProperties(item.properties)}
          <div>
            <span>${unitPriceHtml}</span>
          </div>
        </td>
        <td class="cart-items__quantity" role="cell" headers="quantity">
          <div class="cart-items__quantity-controls">
            <div class="quantity-selector" data-priceflow-quantity-selector>
              <button
                type="button"
                class="quantity-selector__button"
                data-action="decrease"
                aria-label="Decrease quantity"
              >
                <span class="svg-wrapper">
                  {{- 'icon-minus.svg' | inline_asset_content -}}
                </span>
              </button>
              <input
                type="number"
                class="quantity-selector__input"
                value="${item.quantity}"
                min="0"
                max="999"
                data-priceflow-quantity-input
                aria-label="${translations.quantity}"
              />
              <button
                type="button"
                class="quantity-selector__button"
                data-action="increase"
                aria-label="Increase quantity"
              >
                <span class="svg-wrapper">
                  {{- 'icon-plus.svg' | inline_asset_content -}}
                </span>
              </button>
            </div>
            <button
              class="button button--tertiary cart-items__remove"
              type="button"
              aria-label="${translations.removeItem.replace('[TITLE]', escapeHtml(item.product_title))}"
              data-action="remove"
            >
              {{- 'icon-delete.svg' | inline_asset_content -}}
              <span class="visually-hidden">${translations.remove}</span>
            </button>
          </div>
        </td>
        <td class="cart-items__price cart-secondary-typography" role="cell" headers="productTotal">
          <span data-priceflow-line-price>${priceHtml}</span>
        </td>
      </tr>
    `;
  }

  /**
   * Render all cart items in ALL containers on the page
   */
  function renderCartItems() {
    // Find ALL cart product containers (there may be multiple in drawer)
    const containers = document.querySelectorAll('[data-priceflow-cart-products]');
    if (containers.length === 0) return;

    const items = getCartItems();
    const isEmpty = items.length === 0;
    const itemsHtml = items.map((item, index) => renderCartItemRow(item, index)).join('');
    const total = items.reduce((sum, item) => sum + (item.final_line_price || 0), 0);

    // Update ALL containers
    containers.forEach(container => {
      const emptyState = container.querySelector('[data-priceflow-empty-cart]');
      const itemsContainer = container.querySelector('[data-priceflow-cart-items-container]');
      const tbody = container.querySelector('[data-priceflow-cart-items-body]');
      const totalCaption = container.querySelector('[data-priceflow-total-caption]');

      if (!emptyState || !itemsContainer || !tbody) return;

      if (isEmpty) {
        emptyState.style.display = 'block';
        itemsContainer.style.display = 'none';
      } else {
        emptyState.style.display = 'none';
        itemsContainer.style.display = 'block';

        // Render items
        tbody.innerHTML = itemsHtml;

        // Update total caption
        if (totalCaption) {
          totalCaption.textContent = formatPrice(total);
        }

        // Attach event listeners
        attachEventListeners(container);
      }
    });
  }

  /**
   * Attach event listeners to cart item controls
   */
  function attachEventListeners(container) {
    // Quantity buttons
    container.querySelectorAll('[data-action="decrease"], [data-action="increase"]').forEach(btn => {
      btn.addEventListener('click', handleQuantityClick);
    });

    // Quantity inputs
    container.querySelectorAll('[data-priceflow-quantity-input]').forEach(input => {
      input.addEventListener('change', handleQuantityChange);
    });

    // Remove buttons
    container.querySelectorAll('[data-action="remove"]').forEach(btn => {
      btn.addEventListener('click', handleRemoveClick);
    });
  }

  /**
   * Handle quantity button click
   */
  function handleQuantityClick(event) {
    const btn = event.currentTarget;
    const action = btn.dataset.action;
    const row = btn.closest('[data-priceflow-cart-item]');
    const input = row?.querySelector('[data-priceflow-quantity-input]');

    if (!row || !input) return;

    let quantity = parseInt(input.value, 10) || 0;

    if (action === 'decrease') {
      quantity = Math.max(0, quantity - 1);
    } else if (action === 'increase') {
      quantity = Math.min(999, quantity + 1);
    }

    input.value = quantity;
    updateItemQuantity(row.dataset.itemId, quantity);
  }

  /**
   * Handle quantity input change
   */
  function handleQuantityChange(event) {
    const input = event.currentTarget;
    const row = input.closest('[data-priceflow-cart-item]');

    if (!row) return;

    let quantity = parseInt(input.value, 10) || 0;
    quantity = Math.max(0, Math.min(999, quantity));
    input.value = quantity;

    updateItemQuantity(row.dataset.itemId, quantity);
  }

  /**
   * Handle remove button click
   */
  function handleRemoveClick(event) {
    const btn = event.currentTarget;
    const row = btn.closest('[data-priceflow-cart-item]');

    if (!row) return;

    // Add removing animation
    row.style.setProperty('--row-height', `${row.clientHeight}px`);
    row.classList.add('removing');

    setTimeout(() => {
      updateItemQuantity(row.dataset.itemId, 0);
    }, 300);
  }

  /**
   * Update item quantity in LocalStorage
   */
  function updateItemQuantity(itemId, quantity) {
    let items = getCartItems();

    if (quantity <= 0) {
      // Remove item
      items = items.filter(item => item.id !== itemId);
    } else {
      // Update quantity
      items = items.map(item => {
        if (item.id === itemId) {
          return {
            ...item,
            quantity,
            final_line_price: item.final_price * quantity
          };
        }
        return item;
      });
    }

    saveCartItems(items);
    renderCartItems();
  }

  // Prevent duplicate initialization (script may be loaded multiple times)
  if (!window._priceflowCartProductsInitialized) {
    window._priceflowCartProductsInitialized = true;

    // Initial render
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', renderCartItems);
    } else {
      renderCartItems();
    }

    // Listen for cart updates
    window.addEventListener('cartUpdated', renderCartItems);

    // Listen for storage changes (cross-tab sync)
    window.addEventListener('storage', function(event) {
      if (event.key === STORAGE_KEY) {
        renderCartItems();
      }
    });
  } else {
    // Already initialized, just re-render to update any new containers
    renderCartItems();
  }

  // Export for external use
  window.renderPriceflowCartItems = renderCartItems;
})();
</script>

{% stylesheet %}
  .cart-items {
    --cart-item-media-width-min: 2.5rem;
    --cart-item-media-width-max: 7.5rem;

    container-name: cart-items;
    container-type: inline-size;
    width: 100%;
  }

  .cart-items-disabled {
    pointer-events: none;
  }

  .cart-items__table {
    width: 100%;
  }

  .cart-items__table * {
    margin: 0;
  }

  .cart-items__table-row {
    --cart-item-price-width: 6rem;

    display: grid;
    grid-template-columns: clamp(2.5rem, 15cqi, 7.5rem) minmax(0, 1fr) minmax(var(--cart-item-price-width), auto);
    grid-template-areas:
      'media details price'
      'media quantity price'
      'media error error';
    column-gap: var(--gap-md);
    align-items: start;
    padding-bottom: var(--cart-items-gap);
    margin-bottom: var(--margin-lg);
  }

  .cart-items__table-row.removing {
    overflow: hidden;
    animation: removeRow calc(var(--animation-speed) * 2) var(--animation-easing) forwards;
    animation-delay: var(--animation-speed);
  }

  @keyframes removeRow {
    0% {
      height: var(--row-height);
    }
    100% {
      opacity: 0;
      height: 0;
      padding-bottom: 0;
      margin-bottom: 0;
      border-color: transparent;
    }
  }

  .cart-items__table-row:last-child {
    padding-bottom: 0;
  }

  .cart-items--dividers .cart-items__table-row {
    border-bottom: 1px solid var(--color-border);
    margin-bottom: var(--cart-items-gap);
  }

  .cart-items--dividers .cart-items__table-row:last-child {
    border-block-end: none;
    padding-block-end: 0;
    margin-bottom: 0;
  }

  .cart-items__details {
    grid-area: details;
    color: rgb(var(--color-foreground-rgb) / var(--opacity-70));
  }

  .cart-items__details > * + *,
  .cart-items__bundle li {
    margin-block-start: var(--margin-2xs);
  }

  .cart-items__details * {
    font-size: var(--cart-font-size--sm);
  }

  .cart-items__details a {
    text-decoration: none;
  }

  .cart-items__title {
    font-size: var(--cart-font-size--md);
    color: var(--color-foreground);
    text-transform: var(--product-title-case);
  }

  .cart-items__variant {
    display: inline-block;
  }

  .cart-items__quantity {
    grid-area: quantity;
    margin-block-start: var(--margin-xs);
    display: flex;
    align-items: center;
    justify-content: flex-start;
    gap: var(--gap-xs);
    width: fit-content;
  }

  .cart-items__quantity-controls {
    display: flex;
    align-items: center;
    justify-content: flex-start;
    gap: var(--gap-xs);
    width: fit-content;
  }

  .cart-items__remove {
    background-color: transparent;
    color: var(--color-foreground);
    width: var(--minimum-touch-target);
    height: var(--minimum-touch-target);
    justify-content: center;
    box-shadow: none;
    padding: 0;
  }

  .cart-items__media {
    grid-area: media;
    padding: 0;
  }

  .cart-items__price {
    grid-area: price;
    min-height: unset;
    min-width: var(--cart-item-price-width);
    text-align: end;
    display: block;
    font-size: var(--cart-font-size--md);
  }

  .cart-items__media-container {
    display: flex;
    aspect-ratio: var(--ratio);
    position: relative;
    width: 100%;
    overflow: hidden;
  }

  .cart-items__media-image {
    aspect-ratio: inherit;
    object-fit: cover;
    object-position: center center;
    width: 100%;
    height: auto;
  }

  .cart-items__empty-button {
    margin-top: var(--margin-md);
    padding-inline: var(--padding-4xl);
    padding-block: var(--padding-lg);
  }

  .cart-items__properties {
    display: block;
    margin-block-start: var(--margin-2xs);
  }

  .cart-items__properties dt,
  .cart-items__properties dd {
    display: inline;
  }

  /* Quantity selector styles */
  .quantity-selector {
    display: inline-flex;
    align-items: center;
    border: 1px solid var(--color-border);
    border-radius: var(--style-border-radius-inputs);
  }

  .quantity-selector__button {
    background: transparent;
    border: none;
    padding: var(--padding-xs);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    min-width: var(--minimum-touch-target);
    min-height: var(--minimum-touch-target);
  }

  .quantity-selector__button:hover {
    background-color: rgb(var(--color-foreground-rgb) / 0.05);
  }

  .quantity-selector__button .svg-wrapper {
    width: var(--icon-size-xs);
    height: var(--icon-size-xs);
  }

  .quantity-selector__input {
    width: 3rem;
    text-align: center;
    border: none;
    background: transparent;
    font-size: var(--cart-font-size--sm);
    -moz-appearance: textfield;
  }

  .quantity-selector__input::-webkit-outer-spin-button,
  .quantity-selector__input::-webkit-inner-spin-button {
    -webkit-appearance: none;
    margin: 0;
  }

  @container cart-items (min-width: 720px) {
    .cart-items__table-row {
      --cart-item-price-width: 6rem;

      grid-template-columns: 7.5rem 1fr 1fr minmax(var(--cart-item-price-width), auto);
      grid-template-rows: min-content 1fr;
      grid-template-areas:
        'media details quantity price'
        'media details error error';
    }

    .cart-items__quantity,
    .cart-items__price {
      grid-area: initial;
    }

    .cart-items__quantity {
      margin-top: 0;
    }

    .cart-items__price {
      min-height: var(--minimum-touch-target);
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      justify-content: center;
    }
  }

  .cart-primary-typography {
    font-family: var(--cart-primary-font-family);
    font-style: var(--cart-primary-font-style);
    font-weight: var(--cart-primary-font-weight);
  }

  .cart-secondary-typography {
    font-family: var(--cart-secondary-font-family);
    font-style: var(--cart-secondary-font-style);
    font-weight: var(--cart-secondary-font-weight);
  }
{% endstylesheet %}

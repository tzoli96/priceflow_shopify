{% comment %}
  PriceFlow Widget - Theme App Extension Block

  Embeds the storefront configurator for template-based pricing.
  Uses cooperative scroll bridging: the parent scrollbar drives the
  iframe content via postMessage so the widget scrolls naturally
  alongside the rest of the product page.
{% endcomment %}

{% assign widget_url = block.settings.widget_url | default: "https://d1kl8ffas839mv.cloudfront.net/storefront" %}
{% assign variant_id = product.selected_or_first_available_variant.id %}

<div
        id="priceflow-widget-{{ block.id }}"
        class="priceflow-widget"
        data-product-id="{{ product.id }}"
        data-variant-id="{{ variant_id }}"
        data-product-handle="{{ product.handle }}"
        data-shop="{{ shop.permanent_domain }}"
>
  {%- comment -%}
    The spacer grows to match the iframe's full content height.
    The iframe sticks to the viewport top while the user scrolls
    through the spacer, and the parent sends scroll offsets to it.
  {%- endcomment -%}
  <div id="priceflow-spacer-{{ block.id }}" class="priceflow-scroll-spacer">
    <iframe
            id="priceflow-iframe-{{ block.id }}"
            src="{{ widget_url }}?productId={{ product.id }}&shop={{ shop.permanent_domain }}&handle={{ product.handle }}&variant={{ variant_id }}"
            width="100%"
            frameborder="0"
            style="border: none; border-radius: 8px;"
            title="PriceFlow Konfigurátor"
            loading="lazy"
    ></iframe>
  </div>
</div>

{%- comment -%} Mobile sticky bar — lives in parent DOM, outside iframe {%- endcomment -%}
<div id="priceflow-sticky-{{ block.id }}" class="priceflow-sticky" style="display:none;">
  <div class="priceflow-sticky__price">
    <span id="priceflow-sticky-net-{{ block.id }}" class="priceflow-sticky__net">-</span>
    <span id="priceflow-sticky-gross-{{ block.id }}" class="priceflow-sticky__gross"></span>
  </div>
  <button
          id="priceflow-sticky-btn-{{ block.id }}"
          class="priceflow-sticky__btn"
          type="button"
          disabled
  >
    Kosárba teszem
  </button>
</div>

<script>
  (function() {
    var blockId = '{{ block.id }}';
    var spacer  = document.getElementById('priceflow-spacer-' + blockId);
    var iframe  = document.getElementById('priceflow-iframe-' + blockId);
    if (!spacer || !iframe) return;

    var iframeScrollHeight = 0;
    var ticking = false;

    // ---- Mobile sticky bar elements ----
    var stickyBar  = document.getElementById('priceflow-sticky-' + blockId);
    var stickyNet  = document.getElementById('priceflow-sticky-net-' + blockId);
    var stickyGross = document.getElementById('priceflow-sticky-gross-' + blockId);
    var stickyBtn  = document.getElementById('priceflow-sticky-btn-' + blockId);

    function formatHuf(n) {
      return new Intl.NumberFormat('hu-HU', { style: 'currency', currency: 'HUF', minimumFractionDigits: 0, maximumFractionDigits: 0 }).format(n);
    }

    // Sticky button → tell iframe to add to cart
    if (stickyBtn) {
      stickyBtn.addEventListener('click', function() {
        if (iframe.contentWindow) {
          iframe.contentWindow.postMessage({ type: 'PRICEFLOW_STICKY_CLICK' }, '*');
        }
      });
    }

    // ---- Sync: calculate iframe scrollTop from parent scroll position ----
    function syncScroll() {
      if (!iframeScrollHeight) return;

      var spacerRect = spacer.getBoundingClientRect();
      var iframeH    = iframe.offsetHeight;
      var maxScroll  = Math.max(0, iframeScrollHeight - iframeH);

      var scrollTop = Math.max(0, Math.min(-spacerRect.top, maxScroll));

      iframe.contentWindow.postMessage({
        type: 'PRICEFLOW_SCROLL',
        scrollTop: scrollTop
      }, '*');
    }

    // ---- Messages from iframe ----
    window.addEventListener('message', function(event) {
      // Only handle messages from our iframe
      if (iframe.contentWindow && event.source !== iframe.contentWindow) return;

      var data = event.data;
      if (!data || !data.type) return;

      // No template for this product → hide the entire widget
      if (data.type === 'PRICEFLOW_EMPTY') {
        var widget = document.getElementById('priceflow-widget-' + blockId);
        if (widget) {
          widget.style.display = 'none';
        }
        if (stickyBar) {
          stickyBar.style.display = 'none';
        }
        return;
      }

      // Iframe reports its content height → size the spacer
      if (data.type === 'PRICEFLOW_RESIZE' && data.scrollHeight) {
        iframeScrollHeight = data.scrollHeight;
        var iframeH     = iframe.offsetHeight;
        var extraScroll  = Math.max(0, iframeScrollHeight - iframeH);
        spacer.style.height = (iframeH + extraScroll) + 'px';
        // Re-sync immediately in case the page is already scrolled
        syncScroll();
        return;
      }

      // Iframe forwards wheel events → scroll parent page
      if (data.type === 'PRICEFLOW_WHEEL') {
        window.scrollBy({ top: data.deltaY, behavior: 'instant' });
        syncScroll();
        return;
      }

      // Sticky bar state update from iframe
      if (data.type === 'PRICEFLOW_STICKY_UPDATE' && stickyBar) {
        var p = data.payload;
        if (!p || !p.visible) {
          stickyBar.style.display = 'none';
          return;
        }

        stickyBar.style.display = '';

        if (!p.formValid) {
          stickyNet.textContent = 'Töltsd ki a kötelező mezőket';
          stickyGross.textContent = '';
          stickyBtn.disabled = true;
        } else if (p.calculating) {
          stickyNet.textContent = 'Számítás...';
          stickyGross.textContent = '';
          stickyBtn.disabled = true;
        } else if (p.price) {
          stickyNet.textContent = formatHuf(p.price) + ' + Áfa';
          stickyGross.textContent = '(bruttó ' + formatHuf(p.grossPrice) + ')';
          stickyBtn.disabled = false;
        } else {
          stickyNet.textContent = '-';
          stickyGross.textContent = '';
          stickyBtn.disabled = true;
        }

        stickyBtn.disabled = !p.canAddToCart;
        return;
      }

      if (data.type === 'PRICEFLOW_ADD_TO_CART') {
        console.log('[PriceFlow] Add to cart:', data.payload);
      }

      if (data.type === 'PRICEFLOW_CHECKOUT') {
        if (data.payload && data.payload.invoiceUrl) {
          window.location.href = data.payload.invoiceUrl;
        }
      }
    });

    // ---- Parent scroll → drive iframe scroll position ----
    window.addEventListener('scroll', function() {
      if (!ticking) {
        requestAnimationFrame(function() {
          syncScroll();
          ticking = false;
        });
        ticking = true;
      }
    }, { passive: true });
  })();
</script>

<style>
  .priceflow-widget {
    width: 100vw;
    margin-top: 20px;
    margin-bottom: 20px;
  }

  .priceflow-scroll-spacer {
    position: relative;
    width: 100%;
  }

  .priceflow-widget iframe {
    display: block;
    width: 100%;
    height: 100dvh;
    min-height: 300px;
    border: none;
    position: sticky;
    top: 0;
  }

  /* ===== Parent-level mobile sticky bar ===== */
  .priceflow-sticky {
    display: none; /* hidden on desktop by default */
  }

  @media (max-width: 1024px) {
    .priceflow-sticky {
      display: flex;
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      z-index: 2147483647;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      padding: 12px 16px;
      padding-bottom: calc(12px + env(safe-area-inset-bottom));
      background: #fff;
      border-top: 1px solid #e1e3e5;
      box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.10);
    }

    .priceflow-sticky__price {
      display: flex;
      flex-direction: column;
      flex: 1;
      min-width: 0;
    }

    .priceflow-sticky__net {
      font-size: 17px;
      font-weight: 700;
      color: #e91e8c;
      line-height: 1.2;
      white-space: nowrap;
    }

    .priceflow-sticky__gross {
      font-size: 12px;
      color: #6b7280;
      line-height: 1.3;
    }

    .priceflow-sticky__btn {
      flex-shrink: 0;
      padding: 12px 18px;
      background: #e91e8c;
      color: #fff;
      border: none;
      border-radius: 8px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      white-space: nowrap;
      transition: background 0.2s ease;
    }

    .priceflow-sticky__btn:active:not(:disabled) {
      background: #c4177a;
    }

    .priceflow-sticky__btn:disabled {
      background: #e1e3e5;
      color: #6b7280;
      cursor: not-allowed;
    }
  }
</style>

{% schema %}
{
  "name": "PriceFlow Konfigurátor",
  "target": "section",
  "settings": [
    {
      "type": "text",
      "id": "widget_url",
      "label": "Widget URL",
      "default": "http://priceflow-alb-240094690.eu-central-1.elb.amazonaws.com/storefront",
      "info": "A PriceFlow storefront app URL-je"
    }
  ]
}
{% endschema %}

{% comment %}
  PriceFlow Widget - Theme App Extension Block

  Embeds the storefront configurator for template-based pricing.
  The widget communicates with the parent page via postMessage.
{% endcomment %}

{% assign widget_url = block.settings.widget_url | default: "https://d1kl8ffas839mv.cloudfront.net/storefront" %}
{% assign variant_id = product.selected_or_first_available_variant.id %}

<div
  id="priceflow-widget-{{ block.id }}"
  class="priceflow-widget"
  data-product-id="{{ product.id }}"
  data-variant-id="{{ variant_id }}"
  data-product-handle="{{ product.handle }}"
  data-shop="{{ shop.permanent_domain }}"
>
  <iframe
    id="priceflow-iframe-{{ block.id }}"
    src="{{ widget_url }}?productId={{ product.id }}&shop={{ shop.permanent_domain }}&handle={{ product.handle }}&variant={{ variant_id }}"
    width="100%"
    height="{{ block.settings.widget_height | default: 500 }}"
    frameborder="0"
    style="border: none; border-radius: 8px;"
    title="PriceFlow Konfigurátor"
    loading="lazy"
  ></iframe>
</div>

<script>
  // Listen for messages from PriceFlow widget
  window.addEventListener('message', function(event) {
    // Verify origin in production
    var data = event.data;

    if (data.type === 'PRICEFLOW_ADD_TO_CART') {
      // Handle add to cart
      console.log('[PriceFlow] Add to cart:', data.payload);
      // You can integrate with your theme's cart here
    }

    if (data.type === 'PRICEFLOW_CHECKOUT') {
      // Redirect to checkout
      if (data.payload && data.payload.invoiceUrl) {
        window.location.href = data.payload.invoiceUrl;
      }
    }
  });
</script>

<style>
  .priceflow-widget {
    width: 100vw;
    margin-top: 20px;
    margin-bottom: 20px;
  }

  .priceflow-widget iframe {
    display: block;
    width: 100%;
    min-height: 300px;
    border: none;
  }
</style>

{% schema %}
{
  "name": "PriceFlow Konfigurátor",
  "target": "section",
  "settings": [
    {
      "type": "text",
      "id": "widget_url",
      "label": "Widget URL",
      "default": "http://priceflow-alb-240094690.eu-central-1.elb.amazonaws.com/storefront",
      "info": "A PriceFlow storefront app URL-je"
    },
    {
      "type": "range",
      "id": "widget_height",
      "min": 300,
      "max": 800,
      "step": 50,
      "unit": "px",
      "label": "Widget magasság",
      "default": 500
    }
  ]
}
{% endschema %}
